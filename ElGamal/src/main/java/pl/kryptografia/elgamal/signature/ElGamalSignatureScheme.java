package pl.kryptografia.elgamal.signature;

import java.math.BigInteger;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.logging.Level;
import java.util.logging.Logger;
import pl.kryptografia.elgamal.bignum.BigNum;
import pl.kryptografia.elgamal.calculation.EuclideanSolver;
import pl.kryptografia.elgamal.io.BigNumsToBytesConverter;
import pl.kryptografia.elgamal.io.BytesToBigNumsConverter;

/**
 *
 */
public class ElGamalSignatureScheme implements SignatureScheme {

    private final static EuclideanSolver euclideanSolver = EuclideanSolver.getInstance();

    private final static BigNumsToBytesConverter toBytesConverter = new BigNumsToBytesConverter();

    private final static BytesToBigNumsConverter toBigNumsConverter = new BytesToBigNumsConverter();

    private final PublicKey publicKey = new PublicKey();

    private final BigNum primeMinusOne;

    private final BigNum privateKey = new BigNum();

    public static BigInteger bi(BigNum x) {
        BigInteger result = new BigInteger(x.toString(), 2);
        if (x.getSign() == -1) {
            return result.negate();
        }
        return result;
    }

    public ElGamalSignatureScheme() {
        // parameters below were generated using a separate project "Generator"
        String prime = "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011110000010010011011011001011101110000111111100000101010110001001101100000010110010001110000000000100110011110100001011111001010100110100011101010111000001101110010111000011100011110111111101111000111101101001000101010011111010010010101110000011100101100011011110101000000100000001101000001101011101011011001110011001000101101000000000001111111101101010110111001000001011010101101101000000001101101110100110110001101110011111111011110011110000011111110100111011100000101010011001110011101100011001010110011101110111100111100110111010001100110111110111001110110100101001111000001101001101100001000101100001000101010101000011100000100010011001110001110000001100110111011001011100101110001000000111110000111101011010101000010001000001010011100010110001010011011010001001011010010100001100101001100001010000101111011101000110000101001011011100011111100000000001111000101111100100100110101011001010100110110101011101100011001011101000111110100001110111110001101000111001101110110011111010001100101010001110111000011011000100101110000101111101010000010110110001101110001001010001011001001011011100011010011110110100101110110011000111111101011111010011011111011100000011010000001000101001101111010110111101110111111110111101010100001100111010010101111000000110010001010101111001010001101001010000100100100011010111011000101011000100111000010101010000011111100101111111010100100111101100100101000010110011011111101100101111110111011101000001001011011001100001100100001011111110111010001010101110100100011111111000001110000111110010000101011000110100111010110010100110110000101111010000010101110101101010010000011111011101001111010111111110001000111001001000111111110111110001000011110111110100010101101000000010001011001110001111000110001010011100001010011010101001101001000101011100001010011001000101110010101110010010001010011101100001100011000001010000101000001101110001111001000000111100011010110100111001111001000100000111101011011110101110100000011111100110000001011000001100100011000010010011110010001010010011111001011101110001101001000010000010011";
        publicKey.prime.initializeFromBinaryString(prime);
        
        // we often use (p - 1) so we precompute it
        // it is also the order of multiplicative group Zp
        primeMinusOne = new BigNum(publicKey.prime);
        primeMinusOne.subtract(BigNum.ONE);

        String generator = "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010011000001100111010110110000011101000000011001100100100001001111110110011111000110100110001111100111000100010010011000001001101111101100010001111011100010000101111100001001000100000110110100000011001101110101010110101100001001000000000010000111011010101111000100110001010001010101000001100000001010111000011101101101000000110000011110011111110010100010011111011100010110011011100100001110001110101100101100100111101111101010000111111001000010010000110111000000000101101011100011101101110100011101011001000011101001100010110001010100001001011001111111101011100000101010101001010000001100111100101011110010000111110000100011110010111111000111000000111100111111101010000010101110111010010011101011101100111100111011101101101010010111110100111110111010110010101001010000110101110001100101011010011100111110000100101101001110101001110010010111100001100111101101101010000010001100110111101101110010000011101001001110101010011001000001011001111010100101010100011001110011100001010000001101010010111011100110110010001111111000111101000110001001110110111010111110010001010110011110111100111010010110000011011101000000000011000000010001010101100000001010110111001000100000110101101100111111100000011001011000010111111010010001101001110111101101111010000110110000000000101110111010000110101001000011100010110011000000100111011101010010000001101011001011010011000001011001010101110110110111100101100000110011001010011011000101110101111101110110110110011100010111010110000100001110110011011001000110001001000010000100000011011110100100011011101101001010000101001111111001011111000110100101111001100101111100110001001101010100101001000110011101001110110011011101110001100111100011100110001101000111010110111011101010001001001011110100110101000100011100111011000011011111100011101010000001110110010100010101001111111001101001111100001011001101110101011011011010011101101010100011111110000101011001110001010110011111111001001100101001011010000111100000101000111011010100001100000101001101001110111000101010011100000101010110101101001100001011010111000000101000";
        publicKey.generator.initializeFromBinaryString(generator);

        // private key is a random number: 1 <= a < p - 1
        String privateKeyString = "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000001000010101011101001001011000011001110010100110101010010010000000111011100111100001110001110110000001000011100010110111100000001000101110000110001101001100001100111001011110010100010000011111010001101001011101010011110110100001000110111111001010101101010100010110111110100100010010011001101111111100111110010111100010101110111101111010000000001101010011001110011110101101001010100111011101001000010011010001001110110000011000111101101101010010011000001100010111010000000101101101101100000111111010010111000111010011111101101011001000101110110001000110001111001101110010111100000111101011101111001010101001010111000101000100100000101000111101111011110100001110000001101010111000110011001010101110011111100011001011100001000110110101001011010010111001110100001011100101010000100010111100101001110010101001011011111111000101011011100110001101100110000001100111111011010011100101101100101011100100100111110110001001110000010010100101010011000111000010111011000000000011010111000110101011111010011011011110101011001000011111010101010010101000010110000011011110000000011011001000111011000101111001101011010111100011010010010001001111101101111100101011100110010011000001111001011110100011110111000111111110110111101111011000100110001011110001011111010110000001011010110110110011010000101011011111110010000100010000110001110000010101110101001110011010100011010000010111100010010100101100010100110011001110000101001010101011001100001101101010101111011011010010100111100101111010011101001000110010100001011110010001100001110011100100001001011001001101000000001011011001011100010000101001010000001001000010011110110001011011100100101000101011101110100110100001111000011110110110010011111010000101110001100011000101001001001100011000001011010001001011101011100111110110011011101111010011001101010111101010011100001110100011111001101110101000000110110101010110110011101100101010110111100110010111101101001110110111100000000110000111100010010110001110000100010110011000001111011111011001101111101111101111111101100000001001010000110010101111100011010100110";
        privateKey.initializeFromBinaryString(privateKeyString);

        // y = generator^a mod p
        String y = "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001101011000011000101101001110101101100000010010011000101011010110101101001111011110111110100000000110000101001110110010100101111100001111100010010110110101000101011100011000100010010010001100010011010001011100110010110100100100010100111011000110011000010001111101100010110001101101111100101000101111010010101010011010010000011100110010011100001000000110011111010000000001101101011111011111101101100110110001101011111101000101011100101111001101101101001000010111101111111001100101010011010110100001100000001011011111110010110111101001110100010111111011111011100110010000101001001111111110010101001111011101101110100100100111001010101010000001011110011111111110100011000110110011001011000010101101011100111011010101100111010100001000010011000101010100011100110000000110000101010110010111001111010000011100111111110101111101000111010101000000101010000011101010100101010100101100011011001110001000100000011001000011100001101110001101000100000101111010101100011000100111101000101010101011011111101101001000100101111110110110001110001001010100000111110001100111011101100011101011010110101111000000100001111100010100100000010101101111100001110101110000010101010000000101111110100111000000001010111101000001101000100000111111011110110111010111011010101101010110100001110001101101110101111001000111111100001010111011010000100100000011101010001110111101110000101111010101001001110101011011001101011100101101010010010101101101010011100100110001000110111011010010011011101101000110100101000011100010100000110000001011001101010111010111100110100110100101100001011011111000000100010110001110000011000110010010000011001010111111100011111100111100101000011101110111111101100010010010000100010110100100010011100000110101010011001101100001101010000111100111110101001110001111110011101010001110000111011111000100010111111000001100001110110101110101111001100001011101111100100100011010010101011010001101111011001000111000010101001000000100101011011111101011011010111110001100000111010000110111011001000001100111111000101000011111101000011010001111001011001000001010";
        publicKey.y.initializeFromBinaryString(y);
        
        // (p, generator, y) is the public key
        // a is the private key
    }

    @Override
    public byte[] sign(byte[] originalMessage) {
        BigNum k = new BigNum();
        BigNum divisor = null;

        // we need a random number: 1 <= k < p - 1
        // k should be coprime with (p - 1), i. e. gcd(k, p - 1) = 1
        // it is crucial to use different k for every signing, otherwise the 
        // private key can be determined with high probability
        do {
            k.randomize(BigNum.BLOCKS / 2);
            if (!primeMinusOne.absGreaterThan(k) || !k.absGreaterThan(BigNum.ONE)) {
                continue;
            }
            
            divisor = new BigNum(k);
            divisor.gcd(primeMinusOne);
        } while (!divisor.equals(BigNum.ONE));

        // signature is the pair (r, s)
        BigNum r = new BigNum(publicKey.generator);
        r.powerModulo(k, publicKey.prime);

        BigNum kInverse = euclideanSolver.inverseModulo(k, primeMinusOne);

        BigNum digest = hash(originalMessage);

        BigNum s = new BigNum(privateKey);
        s.multiply(r);
        s.modulo(primeMinusOne);
        s.setSign(-1);
        s.add(digest);
        s.modulo(primeMinusOne);
        s.multiply(kInverse);
        s.modulo(primeMinusOne);

        BigNum[] signature = new BigNum[]{r, s};
        return toBytesConverter.bigNumArrayToBytes(signature);
    }

    @Override
    public boolean verify(byte[] originalMessage, byte[] signature) {
        BigNum[] decodedSignature = toBigNumsConverter.convert(signature);
        BigNum r = decodedSignature[0];
        BigNum s = decodedSignature[1];

        // r = generator^k mod p
        // it means that 1 <= r <= p - 1
        if (!r.absGreaterOrEqualTo(BigNum.ONE) || !primeMinusOne.absGreaterOrEqualTo(r)) {
            return false;
        }

        BigNum exponentY = new BigNum(publicKey.y);
        exponentY.powerModulo(r, publicKey.prime);

        BigNum exponentR = new BigNum(r);
        exponentR.powerModulo(s, publicKey.prime);

        exponentY.multiply(exponentR);
        exponentY.modulo(publicKey.prime);

        BigNum digest = hash(originalMessage);
        BigNum pattern = new BigNum(publicKey.generator);
        pattern.powerModulo(digest, publicKey.prime);

        return (exponentY.equals(pattern));
    }

    /**
     * Computes the digest of the original message.
     * 
     * Original ElGamal signature scheme computes the signature for original 
     * message. It may lead to existential forgery attack and to prevent it we
     * sign the message digest.
     * 
     * @param originalMessage Original message to be signed.
     * @return SHA-256 hash of the message.
     */
    private BigNum hash(byte[] originalMessage) {
        try {
            MessageDigest messageDigest = MessageDigest.getInstance("SHA-256");
            byte[] digest = messageDigest.digest(originalMessage);
            byte[] paddedDigest = new byte[BytesToBigNumsConverter.BYTES_PER_BIGNUM];
            for (int i = 0; i < digest.length; ++i) {
                paddedDigest[paddedDigest.length - digest.length + i] = digest[i];
            }
            return toBigNumsConverter.convert(paddedDigest)[0];
        } catch (NoSuchAlgorithmException ex) {
            Logger.getLogger(ElGamalSignatureScheme.class.getName()).log(Level.SEVERE, null, ex);
        }

        return null;
    }
}
